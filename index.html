<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronóstico Meteorológico - UNLP</title>
    <style>
        /* Variables y Reset Básico */
        :root {
            --color-primary: #007bff; /* Azul base */
            --color-dark-blue: #0d47a1; /* Azul oscuro (encabezado) */
            --color-light-blue: #1e88e5; /* Azul medio (subencabezado) */
            --color-fuchsia-bg: #447c94; /* Color de fondo general del pronóstico */
            --color-table-header: #1565c0; /* Azul de encabezado de día (Viernes) */
            --color-saturday-header: #00796b; /* Verde de encabezado (Sábado) */
            --color-text-light: white;
            --color-text-dark: #333;
            --border-radius-lg: 15px;
        }

        body { 
            font-family: Arial, Helvetica, sans-serif; 
            background-color: #e0e0e0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0; 
        }

        .container { 
            width: 800px; 
            max-width: 100%;
            background-color: white; 
            border-radius: var(--border-radius-lg); 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
        }

        /* --- ENCABEZADOS DE LA PÁGINA --- */
        .header-main { 
            background-color: var(--color-dark-blue); 
            color: var(--color-text-light); 
            padding: 8px 20px; 
            text-align: center; 
            font-size: 1.2em; 
            font-weight: bold; 
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .header-sub { 
            background-color: white; /* Fondo blanco */
            color: var(--color-text-dark); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 20px; 
        }

        .header-sub .logo-info { display: flex; align-items: center; gap: 10px; font-size: 0.8em; }
        .header-sub .logo-info img { height: 50px; }
        .header-sub .logo-info .text { font-size: 0.8em; text-align: left; line-height: 1.2; }
        
        .header-sub .center-text { 
            flex-grow: 1; 
            text-align: center; 
            font-size: 2.8em; /* Tamaño grande para el nombre de la ciudad */
            font-weight: 800; /* Extra bold */
            color: var(--color-dark-blue);
            text-transform: uppercase;
        }

        .header-sub .right-logo-info { display: flex; align-items: center; gap: 10px; font-size: 0.8em; }
        .header-sub .right-logo-info .text { font-size: 0.8em; text-align: right; line-height: 1.2; }
        .header-sub .right-logo-info img { height: 50px; }


        /* --- BARRA DE FECHA Y HORA --- */
        .header-info-bar {
            background-color: var(--color-fuchsia-bg); 
            color: white; 
            padding: 10px 20px;
            text-align: right;
            font-size: 1.1em;
            font-weight: bold;
        }
        .header-info-bar #date-emission { float: left; }


        /* --- PESTAÑAS DE CIUDADES --- */
        .city-tabs { 
            display: flex; 
            justify-content: center; 
            background-color: #f0f0f0; 
            padding: 0; 
            margin: 0; 
        }
        .city-tab { 
            padding: 15px 30px; 
            cursor: pointer; 
            font-size: 1.1em; 
            font-weight: bold; 
            color: var(--color-dark-blue); 
            border: none; 
            background-color: transparent; 
            transition: background-color 0.3s; 
            margin: 0 5px;
            border-radius: 5px;
        }
        .city-tab:hover { background-color: #e0e0e0; }
        .city-tab.active { 
            background-color: white; 
            border-bottom: 4px solid var(--color-dark-blue); 
            border-radius: 0; /* Desactiva el radio inferior para la línea */
        }
        
        /* --- SECCIÓN PRINCIPAL DEL PRONÓSTICO --- */
        .tab-content { padding: 0 10px 10px 10px; background-color: white; }
        
        /* --- ESTILO DE LA TABLA DE DÍAS (VIERNES/SÁBADO) --- */
        .day-section { 
            margin: 15px 0; 
            background-color: var(--color-fuchsia-bg); 
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .day-header {
            display: flex;
            background-color: var(--color-table-header);
            color: white;
            font-weight: bold;
            font-size: 1.4em;
            padding: 15px 20px;
            align-items: center;
        }

        .day-name { width: 30%; text-align: left; font-size: 1.4em; }
        .day-name-time { 
            width: 70%; 
            display: flex; 
            justify-content: space-around; 
            font-size: 0.8em; 
            text-align: center; 
        }

        /* Estilos específicos para SÁBADO (Madrugada, Mañana, Tarde, Noche) */
        .day-section.sabado .day-header { background-color: #4CAF50; } /* Verde en el original, ajustado a tu paleta */
        .day-section.sabado .day-name-time { 
            font-size: 0.9em; 
            justify-content: space-between; 
            padding: 0 10px;
        }
        .day-section.sabado .day-name-time > div { width: 25%; } /* Distribuye los 4 tiempos */


        .table-grid {
            display: grid;
            grid-template-columns: 30% repeat(3, 1fr); /* Min/Max + Mañana, Tarde, Noche */
            background-color: var(--color-fuchsia-bg);
            color: white;
            padding: 10px 0;
            gap: 1px 0; /* Espacio entre filas */
        }

        .day-section.sabado .table-grid {
            grid-template-columns: 30% repeat(4, 1fr); /* Min/Max + Madrugada, Mañana, Tarde, Noche */
        }

        .grid-row-label {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 1em;
            background-color: var(--color-fuchsia-bg);
        }

        .grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            text-align: center;
            background-color: var(--color-fuchsia-bg);
            font-size: 1em;
            line-height: 1.2;
        }

        /* Estilos de Temperatura MIN/MAX */
        .temp-min-max-col {
            padding: 10px 20px;
            font-size: 0.8em;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .temp-min-max-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 1.2em;
        }
        .temp-min-max-row span { font-weight: bold; }
        .temp-min-max-row.min-temp { color: #87CEFA; } /* Azul claro para Mínima */
        .temp-min-max-row.max-temp { color: #FFD700; } /* Amarillo para Máxima */
        .temp-min-max-row small { font-size: 0.6em; } /* Estilos para los asteriscos */


        /* Estilos de Íconos y Temps de la Franja Horaria */
        .temp-icon-wrapper img { width: 50px; height: 50px; margin-bottom: 5px; }
        .temp-icon-wrapper { font-size: 2em; }
        .temp-value { font-size: 1.8em; font-weight: bold; }

        /* --- ESTILO DE LAS TARJETAS DE DÍAS (DOMINGO/LUNES) --- */
        .card-forecast-container { 
            display: flex; 
            justify-content: space-between; 
            padding: 0; 
            gap: 15px; 
            margin-top: 15px; 
        }

        .weather-card { 
            flex: 1; 
            background-color: var(--color-fuchsia-bg); 
            color: white; 
            border-radius: var(--border-radius-lg); 
            padding: 20px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            min-height: 350px; /* Para que ambos tengan la misma altura */
        }

        .card-header { font-size: 1.6em; font-weight: 800; border-bottom: 2px solid white; padding-bottom: 5px; }
        .card-date { font-size: 1em; margin-bottom: 10px; }
        
        .card-temp-icon { display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; }
        .card-temp-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .card-temp-group img { width: 70px; height: 70px; }
        .card-temp-group .temp-value { font-size: 1.8em; font-weight: bold; }
        .card-temp-group .temp-value small { font-size: 0.6em; }

        .card-description { font-size: 1.1em; line-height: 1.4; font-weight: 500; }

        .card-wind-info { 
            font-size: 1.1em; 
            font-weight: bold; 
            margin-top: auto; /* Empuja el viento hacia abajo */
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        .card-wind-info img { width: 30px; height: 30px; margin-top: 5px; } /* Flecha de viento */


        /* --- NOTA DE PIE DE PÁGINA --- */
        .footnote { 
            text-align: center; 
            padding: 10px 0; 
            font-size: 0.9em; 
            color: var(--color-text-dark); 
            background-color: white; 
            font-weight: bold;
        }

        /* Ocultar contenido por defecto */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilos del panel de administración (mantener funcionales) */
        #admin-panel { display: none; margin-top: 20px; padding: 20px; background-color: #f9f9f9; border-radius: 10px; width: 800px; max-width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #admin-panel.active { display: block; }
        .admin-form-group { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #fff; }
        .admin-form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--color-dark-blue); font-size: 0.9em;}
        .admin-form-group input, .admin-form-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px; font-size: 1em; }
        .admin-buttons { text-align: right; margin-top: 20px; }
        .admin-buttons button { padding: 10px 15px; background-color: var(--color-dark-blue); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #admin-panel h3 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 25px; color: #333; }
        #admin-panel h4 { margin-top: 20px; color: var(--color-table-header); background-color: #e3f2fd; padding: 5px 10px; border-radius: 5px;}
        #admin-panel h5 { margin-top: 10px; color: #444; font-size: 1em; }
        #login-button, #logout-button { margin-top: 20px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        #login-button { background-color: #4CAF50; }
        #logout-button { background-color: #f44336; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-main">PRONÓSTICO METEOROLÓGICO</div>
        <div class="header-sub">
            <div class="logo-info">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Facultad_de_Ciencias_Astron%C3%B3micas_y_Geof%C3%ADsicas.svg/1200px-Facultad_de_Ciencias_Astron%C3%B3micas_y_Geof%C3%ADsicas.svg.png" alt="Logo">
                <div class="text">Facultad de Ciencias<br>Astronómicas<br>Geofísicas</div>
            </div>
            <div class="center-text" id="city-title">LA PLATA</div>
            <div class="right-logo-info">
                <div class="text">UNIVERSIDAD<br>NACIONAL<br>DE LA PLATA</div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/UNLP_Logo_2016.svg/1200px-UNLP_Logo_2016.svg.png" alt="Logo UNLP">
            </div>
        </div>
        <div class="header-info-bar">
            <span id="date-emission"></span>
            <span id="time-emission"></span>
        </div>

        <div class="city-tabs">
            <button class="city-tab active" data-city="la-plata">LA PLATA</button>
            <button class="city-tab" data-city="mar-del-plata">MAR DEL PLATA</button>
            <button class="city-tab" data-city="junin">JUNÍN</button>
        </div>

        <div id="la-plata" class="tab-content active"></div>
        <div id="mar-del-plata" class="tab-content"></div>
        <div id="junin" class="tab-content"></div>

        <div class="footnote" style="color: black;">* TEMPERATURA EN ZONA SUBURBANA</div>

        <button id="login-button">Iniciar Sesión</button>
        <button id="logout-button" style="display: none;">Cerrar Sesión</button>

        <div id="admin-panel">
            <h2>Panel de Administración de Pronósticos</h2>
            <div class="admin-form-group">
                <label for="admin-city-select">Seleccionar Ciudad a Editar:</label>
                <select id="admin-city-select">
                    <option value="la-plata">La Plata</option>
                    <option value="mar-del-plata">Mar del Plata</option>
                    <option value="junin">Junín</option>
                </select>
            </div>
            <form id="forecast-form">
                <p>Cargando datos de edición...</p>
            </form>
            <div class="admin-buttons">
                <button id="save-button">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <script>
        // *** 1. CONFIGURACIÓN DE FIREBASE (Asegúrate de que esta sea correcta) ***
        const firebaseConfig = {
            apiKey: "AIzaSyCumkjuYFKepwDnUNb-oYGWle_OkgR_y3A",
            authDomain: "web-pronostico.firebaseapp.com",
            projectId: "web-pronostico",
            storageBucket: "web-pronostico.firebasestorage.app",
            messagingSenderId: "328619903034",
            appId: "1:328619903034:web:cb6dabaed0226cfc754d03",
            measurementId: "G-5RN96Y972V"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Referencias a elementos del DOM
        const tabs = document.querySelectorAll('.city-tab');
        const contents = document.querySelectorAll('.tab-content');
        const cityTitle = document.getElementById('city-title');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const adminPanel = document.getElementById('admin-panel');
        const forecastForm = document.getElementById('forecast-form');
        const adminCitySelect = document.getElementById('admin-city-select');
        const saveButton = document.getElementById('save-button');
        const dateEmission = document.getElementById('date-emission');
        const timeEmission = document.getElementById('time-emission');

        // Función auxiliar para normalizar el nombre del ícono
        // (Convierte "Parcialmente Nublado" a "parcialmente-nublado.png")
        function normalizeIconName(text) {
            return text.replace(/\s/g, '-').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace('á', 'a').replace('é', 'e').replace('í', 'i').replace('ó', 'o').replace('ú', 'u');
        }

        // Función para renderizar el pronóstico con el NUEVO diseño
        function renderForecast(cityData, targetElementId) {
            const container = document.getElementById(targetElementId);
            container.innerHTML = ''; // Limpia el contenido anterior
            
            // Actualiza la barra de información
            dateEmission.textContent = cityData.emision.fecha;
            timeEmission.textContent = `Hora de emisión ${cityData.emision.hora}`;


            // --- 1. RENDERIZAR VIERNES/SÁBADO (Formato de TABLA) ---
            const gridDays = ['viernes', 'sabado']; 
            
            gridDays.forEach(dayKey => {
                const day = cityData.pronostico[dayKey];
                if (!day) return;
                
                // Define las franjas horarias y si incluye "Madrugada"
                const timeKeys = dayKey === 'sabado' ? ['madrugada', 'manana', 'tarde', 'noche'] : ['manana', 'tarde', 'noche'];
                
                const daySection = document.createElement('div');
                daySection.className = `day-section ${dayKey}`; 
                daySection.innerHTML = `
                    <div class="day-header">
                        <div class="day-name">${day.dia.toUpperCase()}</div>
                        <div class="day-name-time">
                            ${timeKeys.map(timeKey => `<div>${timeKey.toUpperCase()}</div>`).join('')}
                        </div>
                    </div>
                    <div class="table-grid">
                        <div class="grid-row-label temp-min-max-col">
                            <div class="temp-min-max-row max-temp">
                                🌡️ <span>${day.max_temp}°C</span>
                            </div>
                            <div class="temp-min-max-row min-temp">
                                🌡️ <span>${day.min_temp}°C</span>
                            </div>
                        </div>

                        ${timeKeys.map(timeKey => `
                            <div class="grid-item">
                                <div class="temp-icon-wrapper">
                                    <img src="images/${normalizeIconName(day[timeKey].tiempo)}.png" alt="${day[timeKey].tiempo}">
                                </div>
                                <div class="temp-value">${day[timeKey].temp}°C</div>
                            </div>
                        `).join('')}

                        <div class="grid-row-label">Vientos</div>
                        ${timeKeys.map(timeKey => `<div class="grid-item">${day[timeKey].viento}</div>`).join('')}

                        <div class="grid-row-label">Tiempo</div>
                        ${timeKeys.map(timeKey => `<div class="grid-item">${day[timeKey].tiempo}</div>`).join('')}
                        
                    </div>
                `;
                container.appendChild(daySection);
            });


            // --- 2. RENDERIZAR DOMINGO/LUNES (Formato de TARJETA) ---
            const cardContainer = document.createElement('div');
            cardContainer.className = 'card-forecast-container';
            container.appendChild(cardContainer);

            // Se asume que los datos de las tarjetas están en una subcolección 'semana'
            // Opcionalmente, puedes mapear los días de 'semana' a 'domingo' y 'lunes'
            const cardDays = ['domingo', 'lunes']; 

            cardDays.forEach(cardDayKey => {
                const card = cityData.pronostico[cardDayKey];
                if (!card) return;

                const cardElement = document.createElement('div');
                cardElement.className = 'weather-card';
                cardElement.innerHTML = `
                    <div class="card-header">${card.dia.toUpperCase()}</div>
                    <div class="card-date">${card.fecha}</div>
                    <div class="card-temp-icon">
                        <div class="card-temp-group">
                            <img src="images/${normalizeIconName(card.icono_dia)}.png" alt="${card.icono_dia}">
                            <div class="temp-value">🌡️ ${card.temp_dia}°C<small>*</small></div>
                        </div>
                        <div class="card-temp-group">
                            <img src="images/${normalizeIconName(card.icono_noche)}.png" alt="${card.icono_noche}">
                            <div class="temp-value">🌡️ ${card.temp_noche}°C<small>*</small></div>
                        </div>
                    </div>
                    <div class="card-description">${card.descripcion}</div>
                    <div class="card-wind-info">
                        ${card.viento}
                        <img src="images/arrow-up.png" alt="Dirección de Viento" style="transform: rotate(${card.angulo_viento || 0}deg);">
                    </div>
                `;
                cardContainer.appendChild(cardElement);
            });

        }

        // --- FUNCIONES DE CARGA Y AUTENTICACIÓN (MANTENIDAS DEL CÓDIGO ANTERIOR) ---

        async function loadForecast(cityId) {
            try {
                const docRef = db.collection('ciudades').doc(cityId);
                const doc = await docRef.get();
                if (doc.exists) {
                    currentCityData = doc.data();
                    renderForecast(currentCityData, cityId);
                } else {
                    console.log("No existe el documento para la ciudad:", cityId);
                    document.getElementById(cityId).innerHTML = '<p style="padding: 20px;">Pronóstico no disponible.</p>';
                }
            } catch (e) {
                console.error("Error al cargar el documento:", e);
                alert('Error al cargar los datos. Intente de nuevo.');
            }
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.getAttribute('data-city');
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                contents.forEach(c => c.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                cityTitle.textContent = tab.textContent;
                loadForecast(targetId);
                if (auth.currentUser) { // Recargar admin form si está logueado
                    adminCitySelect.value = targetId;
                    generateAdminForm();
                }
            });
        });

        // Modificación a generateAdminForm para incluir los días de la tarjeta (domingo/lunes)
        async function generateAdminForm() {
            const cityId = adminCitySelect.value;
            const docRef = db.collection('ciudades').doc(cityId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                forecastForm.innerHTML = `<p style="color: red;">No se encontraron datos para ${cityId}.</p>`;
                return;
            }

            const data = doc.data();
            let formHtml = `
                <h3>Datos de Emisión Globales</h3>
                <div class="admin-form-group">
                    <label for="admin-fecha">Fecha (Ej: 03/OCT/25):</label>
                    <input type="text" id="admin-fecha" value="${data.emision.fecha}">
                </div>
                <div class="admin-form-group">
                    <label for="admin-hora">Hora (Ej: 08:00hs):</label>
                    <input type="text" id="admin-hora" value="${data.emision.hora}">
                </div>
                
                <h3>Pronóstico de la Semana (Formato Tabla)</h3>
            `;
            
            // Días de la tabla (viernes y sabado)
            ['viernes', 'sabado'].forEach(dayKey => {
                const day = data.pronostico[dayKey];
                if (!day) return;
                const timeKeys = dayKey === 'sabado' ? ['madrugada', 'manana', 'tarde', 'noche'] : ['manana', 'tarde', 'noche'];

                formHtml += `
                    <h4>${day.dia}</h4>
                    <div style="display: flex; gap: 20px;">
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura Mínima:</label>
                            <input type="number" data-path="pronostico.${dayKey}.min_temp" value="${day.min_temp}">
                        </div>
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura Máxima:</label>
                            <input type="number" data-path="pronostico.${dayKey}.max_temp" value="${day.max_temp}">
                        </div>
                    </div>
                `;
                
                // Franjas horarias de cada día
                timeKeys.forEach(timeKey => {
                    formHtml += `
                        <div style="border: 1px solid #bbdefb; padding: 10px; margin-top: 10px; border-radius: 5px;">
                            <h5>${timeKey.toUpperCase()}</h5>
                            <div class="admin-form-group">
                                <label>Condición del Cielo (Texto, Ej: Despejado):</label>
                                <input type="text" data-path="pronostico.${dayKey}.${timeKey}.tiempo" value="${day[timeKey].tiempo}">
                            </div>
                            <div class="admin-form-group">
                                <label>Temperatura:</label>
                                <input type="number" data-path="pronostico.${dayKey}.${timeKey}.temp" value="${day[timeKey].temp}">
                            </div>
                            <div class="admin-form-group">
                                <label>Viento:</label>
                                <input type="text" data-path="pronostico.${dayKey}.${timeKey}.viento" value="${day[timeKey].viento}">
                            </div>
                        </div>
                    `;
                });
            });
            
            formHtml += `
                <h3>Pronóstico de la Semana (Formato Tarjeta)</h3>
            `;

            // Días de tarjeta (domingo y lunes)
            ['domingo', 'lunes'].forEach(cardDayKey => {
                const card = data.pronostico[cardDayKey];
                if (!card) return;

                formHtml += `
                    <h4>${card.dia} - Tarjeta</h4>
                    <div class="admin-form-group">
                        <label>Fecha (Ej: 05/OCT/25):</label>
                        <input type="text" data-path="pronostico.${cardDayKey}.fecha" value="${card.fecha}">
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura Día:</label>
                            <input type="number" data-path="pronostico.${cardDayKey}.temp_dia" value="${card.temp_dia}">
                        </div>
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Ícono Día (Texto):</label>
                            <input type="text" data-path="pronostico.${cardDayKey}.icono_dia" value="${card.icono_dia}">
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura Noche:</label>
                            <input type="number" data-path="pronostico.${cardDayKey}.temp_noche" value="${card.temp_noche}">
                        </div>
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Ícono Noche (Texto):</label>
                            <input type="text" data-path="pronostico.${cardDayKey}.icono_noche" value="${card.icono_noche}">
                        </div>
                    </div>
                    <div class="admin-form-group">
                        <label>Descripción General (Texto largo):</label>
                        <textarea data-path="pronostico.${cardDayKey}.descripcion" style="width: 100%; height: 80px;">${card.descripcion}</textarea>
                    </div>
                    <div class="admin-form-group">
                        <label>Vientos (Texto):</label>
                        <input type="text" data-path="pronostico.${cardDayKey}.viento" value="${card.viento}">
                    </div>
                    <div class="admin-form-group">
                        <label>Ángulo de Viento (Grados, para la flecha):</label>
                        <input type="number" data-path="pronostico.${cardDayKey}.angulo_viento" value="${card.angulo_viento || 0}">
                    </div>
                `;
            });
            
            forecastForm.innerHTML = formHtml;
        }


        // Lógica para guardar los cambios
        saveButton.addEventListener('click', async () => {
            const cityId = adminCitySelect.value;
            const updates = {};
            // Recolectar todos los inputs con data-path (incluidos los de las tarjetas)
            const inputs = forecastForm.querySelectorAll('input[data-path], textarea[data-path]');
            let isValid = true;

            inputs.forEach(input => {
                const path = input.getAttribute('data-path');
                let value = input.value.trim();
                
                if (input.type === 'number') {
                    if (value === '' || isNaN(value)) {
                        alert(`El campo de temperatura/número en ${path} no puede estar vacío y debe ser un número.`);
                        isValid = false;
                        return;
                    }
                    value = parseFloat(value);
                } else if (value === '') {
                    alert(`El campo de texto en ${path} no puede estar vacío.`);
                    isValid = false;
                    return;
                }
                
                updates[path] = value;
            });
            
            if (!isValid) return;

            // Datos de emisión
            updates['emision.fecha'] = document.getElementById('admin-fecha').value.trim();
            updates['emision.hora'] = document.getElementById('admin-hora').value.trim();
            
            if (updates['emision.fecha'] === '' || updates['emision.hora'] === '') {
                 alert('Los campos de fecha y hora de emisión no pueden estar vacíos.');
                 return;
            }

            try {
                await db.collection('ciudades').doc(cityId).update(updates);
                alert('✅ ¡Cambios guardados con éxito!');
                
                const activeTab = document.querySelector('.city-tab.active').getAttribute('data-city');
                if (activeTab === cityId) {
                    loadForecast(cityId);
                }
            } catch (e) {
                console.error("Error al guardar los cambios:", e);
                alert('❌ Error al guardar los cambios. Revisa la consola para más detalles o verifica tus permisos de Firestore.');
            }
        });

        // Manejador del select de ciudades en el panel de admin
        adminCitySelect.addEventListener('change', generateAdminForm);
            
        // Lógica de autenticación (sin cambios)
        auth.onAuthStateChanged(user => {
            if (user) {
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                adminPanel.style.display = 'block';
                generateAdminForm(); 
            } else {
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                adminPanel.style.display = 'none';
                forecastForm.innerHTML = '<p>Debes iniciar sesión para editar el pronóstico.</p>';
            }
        });
        
        loginButton.addEventListener('click', () => {
            const email = prompt("Ingresa tu correo electrónico:");
            const password = prompt("Ingresa tu contraseña:");
            if (email && password) {
                auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    alert('Error al iniciar sesión: ' + error.message);
                });
            }
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // Carga el pronóstico inicial
        document.addEventListener('DOMContentLoaded', () => {
            loadForecast('la-plata');
        });
    </script>
</body>
</html>
