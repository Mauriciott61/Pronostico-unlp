<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pron√≥stico Meteorol√≥gico - UNLP</title>

    <style>
        /* --- INCRUSTACI√ìN DE FUENTE GARET --- */
        @font-face {
            font-family: 'Garet';
            src: url('fonts/Garet-Heavy.woff2') format('woff2'); 
            font-weight: 800; 
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Garet';
            src: url('fonts/Garet-Medium.woff2') format('woff2'); 
            font-weight: 500; 
            font-style: normal;
            font-display: swap;
        }
        
        /* Variables y Reset B√°sico */
        :root {
            --color-primary: #007bff;
            --color-dark-blue: #0d47a1;
            --color-light-blue: #1e88e5;
            --color-bg: #EAECEF; /* Fondo de la p√°gina */
            --color-fuchsia-bg: #274E6F; /* Azul oscuro dominante del pron√≥stico */
            --color-table-header-viernes: #1C6793; /* Azul medio para Viernes */
            --color-table-header-sabado: #3D77B2; /* Azul m√°s claro para S√°bado */
            --color-text-light: white;
            --color-text-dark: #333;
            --border-radius-lg: 15px;
        }

        body { 
            font-family: 'Garet', Arial, sans-serif; 
            background-color: var(--color-bg); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px 0; 
            margin: 0; 
        }

        .container { 
            width: 800px; 
            max-width: 100%;
            background-color: white; 
            border-radius: 0; 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
        }

        /* --- ENCABEZADOS DE LA P√ÅGINA --- */
        .header-main { 
            background-color: var(--color-dark-blue); 
            color: var(--color-text-light); 
            padding: 8px 20px; 
            text-align: center; 
            font-size: 1.1em; 
            font-weight: 800; 
            border-radius: 0;
            clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%); 
            margin-bottom: -15px; 
            position: relative;
            z-index: 10;
        }
        
        .header-sub { 
            background-color: white;
            color: var(--color-text-dark); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px; 
        }

        .header-sub .center-text { 
            flex-grow: 1; 
            text-align: center; 
            font-size: 3em; 
            font-weight: 800; 
            color: var(--color-fuchsia-bg); 
            text-transform: uppercase;
        }

        .header-sub img { height: 60px; }
        .header-sub .text { font-size: 0.7em; line-height: 1.1; font-weight: 500; }
        .header-sub .logo-info, .header-sub .right-logo-info { align-items: flex-start; }


        /* --- BARRA DE FECHA Y HORA --- */
        .header-info-bar {
            background-color: var(--color-fuchsia-bg); 
            color: white; 
            padding: 10px 20px;
            text-align: right;
            font-size: 1.1em;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
        }

        /* --- PESTA√ëAS DE CIUDADES --- */
        .city-tabs { 
            display: flex; 
            justify-content: center; 
            background-color: white; /* Cambiado a blanco para integrarse */
            border-bottom: 2px solid #ccc; 
            padding: 0; 
            margin: 0; 
        }
        .city-tab { 
            padding: 10px 20px; 
            cursor: pointer; 
            font-size: 1.0em; 
            font-weight: 800; /* Garet Heavy */
            color: var(--color-fuchsia-bg); 
            border: none; 
            background-color: transparent; 
            transition: color 0.3s;
        }
        .city-tab.active { 
            border-bottom: 4px solid var(--color-fuchsia-bg); 
            color: var(--color-fuchsia-bg); 
            background-color: #f0f0f0; /* Color tenue para el fondo de la pesta√±a activa */
        }
        
        .tab-content { display: none; padding: 0; background-color: white; }
        .tab-content.active { display: block; }
        
        /* --- ESTILO DE LA TABLA DE D√çAS (VIERNES/S√ÅBADO) --- */
        .day-section { 
            margin: 15px 15px; 
            background-color: var(--color-fuchsia-bg); 
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }

        .day-header {
            background-color: var(--color-table-header-viernes); 
            color: white;
            font-size: 1.4em;
            padding: 15px 20px;
        }
        .day-section.sabado .day-header { background-color: var(--color-table-header-sabado); }

        .day-name { font-weight: 800; } 

        .table-grid {
            display: grid;
            /* La plantilla se define en JS para manejar 3 o 4 franjas */
            background-color: var(--color-fuchsia-bg);
            color: white;
            padding: 10px 0;
            gap: 1px 0;
            align-items: stretch;
            text-align: center;
        }
        
        /* Fila de T√≠tulo de Grilla (Temperatura, Vientos, Tiempo) */
        .grid-row-label {
            justify-content: flex-start;
            font-weight: 800;
            font-size: 1.1em;
            background-color: transparent;
            text-align: left;
            padding: 15px 20px;
            align-items: center;
        }

        .grid-item {
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 500; 
            padding: 15px 5px;
        }
        
        /* Estilos de Temperatura MIN/MAX */
        .temp-min-max-col {
            padding: 15px 20px;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
        }
        .temp-min-max-row {
            font-size: 1.4em;
            font-weight: 800; 
        }
        .max-temp::before { content: 'üå°Ô∏è'; color: red; margin-right: 5px; font-size: 0.8em; }
        .min-temp::before { content: 'üå°Ô∏è'; color: #87CEFA; margin-right: 5px; font-size: 0.8em; }
        .temp-min-max-row small { font-size: 0.6em; font-weight: 400; }
        
        /* Estilos de √çconos y Temps de la Franja Horaria */
        .temp-icon-wrapper img { width: 60px; height: 60px; margin-bottom: 5px; }
        .temp-icon-wrapper { font-size: 2.5em; font-weight: 800; }
        .temp-value { font-size: 2.2em; font-weight: 800; } 

        /* --- ESTILO DE LAS TARJETAS DE D√çAS (DOMINGO/LUNES) --- */
        .card-forecast-container { 
            margin: 15px; 
            gap: 15px; 
            padding: 0; 
            display: flex;
            justify-content: space-between;
        }

        .weather-card { 
            flex: 1;
            background-color: var(--color-fuchsia-bg); 
            color: white;
            border-radius: var(--border-radius-lg); 
            padding: 25px; 
            gap: 20px;
            min-height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .card-header { font-size: 1.8em; font-weight: 800; border-bottom: none; }
        .card-date { font-size: 1.1em; font-weight: 500; }
        
        .card-temp-icon { gap: 30px; display: flex; justify-content: center; align-items: center; }
        .card-temp-group { 
            gap: 10px;
            background: rgba(255, 255, 255, 0.1); 
            padding: 10px; 
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card-temp-group img { width: 80px; height: 80px; }
        .card-temp-group .temp-value { font-size: 1.5em; font-weight: 800; } 
        .card-temp-group .temp-value small { font-size: 0.6em; }

        .card-description { font-size: 1.2em; line-height: 1.5; font-weight: 500; }

        .card-wind-info { 
            font-size: 1.1em; 
            font-weight: 500; 
            border-top: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card-wind-info img { width: 35px; height: 35px; margin-top: 10px; }

        /* --- NOTA DE PIE DE P√ÅGINA --- */
        .footnote { 
            text-align: center; 
            padding: 10px 0 20px 0; 
            font-size: 0.9em; 
            font-weight: 500;
            color: var(--color-text-dark); 
            background-color: white; 
        }

        /* Estilos de administraci√≥n */
        #admin-panel { 
            display: none; 
            margin-top: 20px; 
            padding: 20px; 
            background-color: #f9f9f9; 
            border-radius: 10px; 
            width: 800px; 
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        #admin-panel.active { display: block; }
        .admin-form-group { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #fff; }
        .admin-form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--color-dark-blue); font-size: 0.9em;}
        .admin-form-group input, .admin-form-group select, .admin-form-group textarea { 
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 4px;
        }
        .admin-buttons { text-align: right; margin-top: 20px; }
        .admin-buttons button { 
            padding: 10px 15px; 
            background-color: var(--color-dark-blue); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        #login-button, #logout-button { 
            margin-top: 10px; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            color: white; 
            font-weight: 500;
        }
        #login-button { background-color: #4CAF50; }
        #logout-button { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-main">PRON√ìSTICO METEOROL√ìGICO</div>
        <div class="header-sub">
            <div class="logo-info">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Facultad_de_Ciencias_Astron%C3%B3micas_y_Geof%C3%ADsicas.svg/1200px-Facultad_de_Ciencias_Astron%C3%B3micas_y_Geof%C3%ADsicas.svg.png" alt="Logo">
                <div class="text">Facultad de Ciencias<br>Astron√≥micas<br>Geof√≠sicas</div>
            </div>
            <div class="center-text" id="city-title">LA PLATA</div>
            <div class="right-logo-info">
                <div class="text">UNIVERSIDAD<br>NACIONAL<br>DE LA PLATA</div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/UNLP_Logo_2016.svg/1200px-UNLP_Logo_2016.svg.png" alt="Logo UNLP">
            </div>
        </div>
        <div class="header-info-bar">
            <span id="date-emission"></span>
            <span id="time-emission"></span>
        </div>

        <div class="city-tabs">
            <button class="city-tab active" data-city="la-plata">LA PLATA</button>
            <button class="city-tab" data-city="mar-del-plata">MAR DEL PLATA</button>
            <button class="city-tab" data-city="junin">JUN√çN</button>
        </div>

        <div id="la-plata" class="tab-content active"></div>
        <div id="mar-del-plata" class="tab-content"></div>
        <div id="junin" class="tab-content"></div>

        <button id="login-button">Iniciar Sesi√≥n</button>
        <button id="logout-button" style="display: none;">Cerrar Sesi√≥n</button>

        <div id="admin-panel">
            <h2>Panel de Administraci√≥n de Pron√≥sticos</h2>
            <div class="admin-form-group">
                <label for="admin-city-select">Seleccionar Ciudad a Editar:</label>
                <select id="admin-city-select">
                    <option value="la-plata">La Plata</option>
                    <option value="mar-del-plata">Mar del Plata</option>
                    <option value="junin">Jun√≠n</option>
                </select>
            </div>
            <form id="forecast-form">
                <p>Cargando datos de edici√≥n...</p>
            </form>
            <div class="admin-buttons">
                <button id="save-button">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <script>
        // *** 1. CONFIGURACI√ìN DE FIREBASE (TU CONFIG) ***
        const firebaseConfig = {
            apiKey: "AIzaSyCumkjuYFKepwDnUNb-oYGWle_OkgR_y3A",
            authDomain: "web-pronostico.firebaseapp.com",
            projectId: "web-pronostico",
            storageBucket: "web-pronostico.firebasestorage.app",
            messagingSenderId: "328619903034",
            appId: "1:328619903034:web:cb6dabaed0226cfc754d03",
            measurementId: "G-5RN96Y972V"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Referencias a elementos del DOM
        const tabs = document.querySelectorAll('.city-tab');
        const contents = document.querySelectorAll('.tab-content');
        const cityTitle = document.getElementById('city-title');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const adminPanel = document.getElementById('admin-panel');
        const forecastForm = document.getElementById('forecast-form');
        const adminCitySelect = document.getElementById('admin-city-select');
        const saveButton = document.getElementById('save-button');
        const dateEmission = document.getElementById('date-emission');
        const timeEmission = document.getElementById('time-emission');

        let currentCityData = null; 

        // Funci√≥n auxiliar para normalizar el nombre del √≠cono
        function normalizeIconName(text) {
            return text.replace(/\s/g, '-').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/√°/g, 'a').replace(/√©/g, 'e').replace(/√≠/g, 'i').replace(/√≥/g, 'o').replace(/√∫/g, 'u');
        }

        // --- 2. FUNCI√ìN PRINCIPAL DE RENDERIZADO (Con estructura final) ---
        function renderForecast(cityData, targetElementId) {
            const container = document.getElementById(targetElementId);
            container.innerHTML = ''; // Limpia el contenido anterior
            
            // Actualiza la barra de informaci√≥n
            dateEmission.textContent = cityData.emision.fecha;
            timeEmission.textContent = `Hora de emisi√≥n ${cityData.emision.hora}`;


            // --- 1. RENDERIZAR D√çAS EN FORMATO DE TABLA (VIERNES, S√ÅBADO) ---
            const gridDays = ['viernes', 'sabado']; 
            
            gridDays.forEach(dayKey => {
                const day = cityData.pronostico[dayKey];
                if (!day) return;
                
                // Define las franjas horarias y si incluye "Madrugada"
                const timeKeys = dayKey === 'sabado' ? ['madrugada', 'manana', 'tarde', 'noche'] : ['manana', 'tarde', 'noche'];
                
                const daySection = document.createElement('div');
                daySection.className = `day-section ${dayKey}`; 
                daySection.innerHTML = `
                    <div class="day-header">
                        <div class="day-name">${day.dia.toUpperCase()}</div>
                    </div>
                    <div class="table-grid" style="grid-template-columns: 30% repeat(${timeKeys.length}, 1fr);">
                        <div class="grid-row-label" style="font-weight: 500;"></div>
                        ${timeKeys.map(timeKey => `<div class="grid-item" style="font-weight: 800;">${timeKey.toUpperCase()}</div>`).join('')}

                        <div class="grid-row-label temp-min-max-col">
                            <div class="temp-min-max-row max-temp">
                                <span>${day.max_temp}¬∞C</span>
                            </div>
                            <div class="temp-min-max-row min-temp">
                                <span>${day.min_temp}¬∞C</span>
                            </div>
                        </div>

                        ${timeKeys.map(timeKey => `
                            <div class="grid-item">
                                <div class="temp-icon-wrapper">
                                    <img src="images/${normalizeIconName(day[timeKey].tiempo)}.png" alt="${day[timeKey].tiempo}">
                                </div>
                                <div class="temp-value">${day[timeKey].temp}¬∞C</div>
                            </div>
                        `).join('')}

                        <div class="grid-row-label">Vientos</div>
                        ${timeKeys.map(timeKey => `<div class="grid-item">${day[timeKey].viento}</div>`).join('')}

                        <div class="grid-row-label">Tiempo</div>
                        ${timeKeys.map(timeKey => `<div class="grid-item">${day[timeKey].tiempo}</div>`).join('')}
                        
                    </div>
                `;
                container.appendChild(daySection);
            });


            // --- 2. RENDERIZAR D√çAS EN FORMATO DE TARJETA (DOMINGO, LUNES) ---
            const cardContainer = document.createElement('div');
            cardContainer.className = 'card-forecast-container';
            container.appendChild(cardContainer);

            const cardDays = ['domingo', 'lunes']; 

            cardDays.forEach(cardDayKey => {
                const card = cityData.pronostico[cardDayKey];
                if (!card) return;

                const cardElement = document.createElement('div');
                cardElement.className = 'weather-card';
                cardElement.innerHTML = `
                    <div class="card-header">${card.dia.toUpperCase()}</div>
                    <div class="card-date">${card.fecha}</div>
                    <div class="card-temp-icon">
                        <div class="card-temp-group">
                            <img src="images/${normalizeIconName(card.icono_dia)}.png" alt="${card.icono_dia}">
                            <div class="temp-value"> ${card.temp_dia}¬∞C<small>*</small></div>
                        </div>
                        <div class="card-temp-group">
                            <img src="images/${normalizeIconName(card.icono_noche)}.png" alt="${card.icono_noche}">
                            <div class="temp-value"> ${card.temp_noche}¬∞C<small>*</small></div>
                        </div>
                    </div>
                    <div class="card-description">${card.descripcion}</div>
                    <div class="card-wind-info">
                        ${card.viento}
                        <img src="images/arrow-up.png" alt="Direcci√≥n de Viento" style="transform: rotate(${card.angulo_viento || 0}deg);">
                    </div>
                `;
                cardContainer.appendChild(cardElement);
            });

            // Pie de p√°gina
            const footnote = document.createElement('div');
            footnote.className = 'footnote';
            footnote.textContent = '* TEMPERATURA EN ZONA SUBURBANA';
            container.appendChild(footnote);

        }

        // Funci√≥n para cargar los datos de una ciudad
        async function loadForecast(cityId) {
            try {
                const docRef = db.collection('ciudades').doc(cityId);
                const doc = await docRef.get();
                if (doc.exists) {
                    currentCityData = doc.data();
                    renderForecast(currentCityData, cityId);
                } else {
                    console.error("No existe el documento para la ciudad:", cityId);
                    document.getElementById(cityId).innerHTML = `<p style="padding: 20px; text-align: center; color: red;">Pron√≥stico no disponible para esta ciudad.</p>`;
                }
            } catch (e) {
                console.error("Error al cargar el documento:", e);
                alert('Error al cargar los datos. Intente de nuevo.');
            }
        }


        // L√≥gica de las pesta√±as
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.getAttribute('data-city');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                contents.forEach(c => c.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');

                cityTitle.textContent = tab.textContent;
                loadForecast(targetId);
                
                // Si el panel de admin est√° activo, actualiza el selector
                if (auth.currentUser) {
                    document.getElementById('admin-city-select').value = targetId;
                    generateAdminForm();
                }
            });
        });


        // --- 3. L√ìGICA DE ADMINISTRACI√ìN (Con estructura final) ---

        // Funci√≥n para generar el formulario de edici√≥n
        async function generateAdminForm() {
            const cityId = adminCitySelect.value;
            const docRef = db.collection('ciudades').doc(cityId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                forecastForm.innerHTML = `<p style="color: red;">No se encontraron datos para ${cityId}.</p>`;
                return;
            }

            const data = doc.data();
            let formHtml = `
                <h3>Datos de Emisi√≥n Globales</h3>
                <div class="admin-form-group">
                    <label for="admin-fecha">Fecha (Ej: 03/OCT/25):</label>
                    <input type="text" id="admin-fecha" value="${data.emision.fecha}">
                </div>
                <div class="admin-form-group">
                    <label for="admin-hora">Hora (Ej: 08:00hs):</label>
                    <input type="text" id="admin-hora" value="${data.emision.hora}">
                </div>
                
                <h3>Pron√≥stico de la Semana (Formato Tabla)</h3>
            `;
            
            // D√≠as de la tabla (viernes y sabado)
            ['viernes', 'sabado'].forEach(dayKey => {
                const day = data.pronostico[dayKey];
                if (!day) return;
                const timeKeys = dayKey === 'sabado' ? ['madrugada', 'manana', 'tarde', 'noche'] : ['manana', 'tarde', 'noche'];

                formHtml += `
                    <h4>${day.dia}</h4>
                    <div style="display: flex; gap: 20px;">
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura M√≠nima:</label>
                            <input type="number" data-path="pronostico.${dayKey}.min_temp" value="${day.min_temp}">
                        </div>
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura M√°xima:</label>
                            <input type="number" data-path="pronostico.${dayKey}.max_temp" value="${day.max_temp}">
                        </div>
                    </div>
                `;
                
                // Franjas horarias de cada d√≠a
                timeKeys.forEach(timeKey => {
                    const timeData = day[timeKey] || { tiempo: '', temp: 0, viento: '' };
                    formHtml += `
                        <div style="border: 1px solid #bbdefb; padding: 10px; margin-top: 10px; border-radius: 5px;">
                            <h5>${timeKey.toUpperCase()}</h5>
                            <div class="admin-form-group">
                                <label>Condici√≥n del Cielo (Texto, Ej: Despejado. Debe coincidir con nombre de archivo):</label>
                                <input type="text" data-path="pronostico.${dayKey}.${timeKey}.tiempo" value="${timeData.tiempo}">
                            </div>
                            <div class="admin-form-group">
                                <label>Temperatura:</label>
                                <input type="number" data-path="pronostico.${dayKey}.${timeKey}.temp" value="${timeData.temp}">
                            </div>
                            <div class="admin-form-group">
                                <label>Viento:</label>
                                <input type="text" data-path="pronostico.${dayKey}.${timeKey}.viento" value="${timeData.viento}">
                            </div>
                        </div>
                    `;
                });
            });
            
            formHtml += `
                <h3>Pron√≥stico de la Semana (Formato Tarjeta)</h3>
            `;

            // D√≠as de tarjeta (domingo y lunes)
            ['domingo', 'lunes'].forEach(cardDayKey => {
                const card = data.pronostico[cardDayKey];
                if (!card) return;

                formHtml += `
                    <h4>${card.dia} - Tarjeta</h4>
                    <div class="admin-form-group">
                        <label>Fecha (Ej: 05/OCT/25):</label>
                        <input type="text" data-path="pronostico.${cardDayKey}.fecha" value="${card.fecha}">
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura D√≠a:</label>
                            <input type="number" data-path="pronostico.${cardDayKey}.temp_dia" value="${card.temp_dia}">
                        </div>
                        <div class="admin-form-group" style="flex: 1;">
                            <label>√çcono D√≠a (Texto):</label>
                            <input type="text" data-path="pronostico.${cardDayKey}.icono_dia" value="${card.icono_dia}">
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div class="admin-form-group" style="flex: 1;">
                            <label>Temperatura Noche:</label>
                            <input type="number" data-path="pronostico.${cardDayKey}.temp_noche" value="${card.temp_noche}">
                        </div>
                        <div class="admin-form-group" style="flex: 1;">
                            <label>√çcono Noche (Texto):</label>
                            <input type="text" data-path="pronostico.${cardDayKey}.icono_noche" value="${card.icono_noche}">
                        </div>
                    </div>
                    <div class="admin-form-group">
                        <label>Descripci√≥n General (Texto largo):</label>
                        <textarea data-path="pronostico.${cardDayKey}.descripcion" style="width: 100%; height: 80px;">${card.descripcion}</textarea>
                    </div>
                    <div class="admin-form-group">
                        <label>Vientos (Texto):</label>
                        <input type="text" data-path="pronostico.${cardDayKey}.viento" value="${card.viento}">
                    </div>
                    <div class="admin-form-group">
                        <label>√Ångulo de Viento (Grados, para la flecha):</label>
                        <input type="number" data-path="pronostico.${cardDayKey}.angulo_viento" value="${card.angulo_viento || 0}">
                    </div>
                `;
            });
            
            forecastForm.innerHTML = formHtml;
        }

        // L√≥gica para guardar los cambios
        saveButton.addEventListener('click', async () => {
            const cityId = adminCitySelect.value;
            const updates = {};
            const inputs = forecastForm.querySelectorAll('input[data-path], textarea[data-path]');
            let isValid = true;

            inputs.forEach(input => {
                const path = input.getAttribute('data-path');
                let value = input.value.trim();
                
                if (input.type === 'number') {
                    if (value === '' || isNaN(value)) {
                        alert(`El campo de temperatura/n√∫mero en ${path} no puede estar vac√≠o y debe ser un n√∫mero.`);
                        isValid = false;
                        return;
                    }
                    value = parseFloat(value);
                } else if (value === '') {
                    alert(`El campo de texto en ${path} no puede estar vac√≠o.`);
                    isValid = false;
                    return;
                }
                
                updates[path] = value;
            });
            
            if (!isValid) return;

            // Datos de emisi√≥n
            updates['emision.fecha'] = document.getElementById('admin-fecha').value.trim();
            updates['emision.hora'] = document.getElementById('admin-hora').value.trim();
            
            if (updates['emision.fecha'] === '' || updates['emision.hora'] === '') {
                 alert('Los campos de fecha y hora de emisi√≥n no pueden estar vac√≠os.');
                 return;
            }

            try {
                await db.collection('ciudades').doc(cityId).update(updates);
                alert('‚úÖ ¬°Cambios guardados con √©xito!');
                
                // Recargar el pron√≥stico si la ciudad actual es la editada
                if (document.querySelector('.city-tab.active').getAttribute('data-city') === cityId) {
                    loadForecast(cityId);
                }
            } catch (e) {
                console.error("Error al guardar los cambios:", e);
                alert('Error al guardar los cambios. Intente de nuevo.');
            }
        });


        // L√≥gica de autenticaci√≥n
        auth.onAuthStateChanged(user => {
            if (user) {
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                adminPanel.style.display = 'block';
                generateAdminForm();
            } else {
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                adminPanel.style.display = 'none';
            }
        });

        // Manejador del select de ciudades en el panel de admin
        adminCitySelect.addEventListener('change', generateAdminForm);
        
        // Manejadores de eventos del bot√≥n de login y logout (Mantienes tu l√≥gica de prompt)
        loginButton.addEventListener('click', () => {
             const email = prompt("Ingresa tu correo electr√≥nico:");
             const password = prompt("Ingresa tu contrase√±a:");
             if (email && password) {
                 auth.signInWithEmailAndPassword(email, password).catch(error => {
                     alert('Error al iniciar sesi√≥n: ' + error.message);
                 });
             }
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });


        // *** Carga el pron√≥stico inicial al cargar la p√°gina ***
        document.addEventListener('DOMContentLoaded', () => {
            loadForecast('la-plata');
        });
    </script>
</body>
</html>
