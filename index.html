// ... (Tu configuraci√≥n de Firebase anterior) ...
const firebaseConfig = {
    apiKey: "AIzaSyCumkjuYFKepwDnUNb-oYGWle_OkgR_y3A",
    authDomain: "web-pronostico.firebaseapp.com",
    projectId: "web-pronostico",
    storageBucket: "web-pronostico.firebasestorage.app",
    messagingSenderId: "328619903034",
    appId: "1:328619903034:web:cb6dabaed0226cfc754d03",
    measurementId: "G-5RN96Y972V"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();


// Referencias a elementos del DOM
const tabs = document.querySelectorAll('.city-tab');
const contents = document.querySelectorAll('.tab-content');
const cityTitle = document.getElementById('city-title');
const loginButton = document.getElementById('login-button');
const logoutButton = document.getElementById('logout-button');
const adminPanel = document.getElementById('admin-panel');
const forecastForm = document.getElementById('forecast-form');
const adminCitySelect = document.getElementById('admin-city-select');
const saveButton = document.getElementById('save-button');
const dateEmission = document.getElementById('date-emission');
const timeEmission = document.getElementById('time-emission');


let currentCityData = {}; 


// Datos de las ciudades para el mapa
const cities = [
    { id: 'la-plata', name: 'LA PLATA', lat: -34.9213, lng: -57.9544 },
    { id: 'mar-del-plata', name: 'MAR DEL PLATA', lat: -38.0049, lng: -57.5451 },
    { id: 'junin', name: 'JUN√çN', lat: -34.5833, lng: -60.9500 }
];


// *** L√ìGICA DEL MAPA (Implementaci√≥n con Leaflet) ***
function initLeafletMap() {
    // 1. Inicializar el mapa, centrado en la Provincia de Buenos Aires
    const bsasCenter = [-36.0, -60.0];
    const map = L.map('mapa').setView(bsasCenter, 7); // 'mapa' es el ID del contenedor, 7 es el nivel de zoom

    // 2. A√±adir la capa base (OpenStreetMap tiles)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // 3. Crear marcadores para cada ciudad
    cities.forEach(city => {
        // Marcador est√°ndar de Leaflet
        const marker = L.marker([city.lat, city.lng]).addTo(map)
            .bindPopup(city.name); // Muestra el nombre al pasar el rat√≥n

        // Evento de clic en el marcador: activa la pesta√±a y el pron√≥stico
        marker.on('click', () => {
            activateCityTab(city.id, city.name);
            // Opcional: Centrar el mapa en el marcador al hacer clic
            map.setView([city.lat, city.lng], 8); 
        });
    });
}


// Funci√≥n unificada para manejar la selecci√≥n de ciudad (por pesta√±a o mapa)
function activateCityTab(targetId, targetName) {
    // 1. Activar visualmente la pesta√±a
    tabs.forEach(t => {
        t.classList.remove('active');
        if (t.getAttribute('data-city') === targetId) {
            t.classList.add('active');
        }
    });

    // 2. Mostrar el contenido del pron√≥stico
    contents.forEach(c => c.classList.remove('active'));
    document.getElementById(targetId).classList.add('active');

    // 3. Actualizar el t√≠tulo
    cityTitle.textContent = targetName;
    
    // 4. Cargar los datos del pron√≥stico
    loadForecast(targetId);
}


// Funci√≥n para renderizar el pron√≥stico (se mantiene igual)
function renderForecast(cityData, targetElementId) {
    const container = document.getElementById(targetElementId);
    container.innerHTML = ''; 

    // Renderizar los d√≠as en formato de tabla
    const gridDays = ['hoy', 'manana'];
    gridDays.forEach(dayKey => {
        const day = cityData.pronostico[dayKey];
        if (!day) return;

        const daySection = document.createElement('div');
        daySection.className = `grid-day-section ${day.dia.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace('√°', 'a')}`;
        daySection.innerHTML = `
            <div class="grid-day-header">
                <div class="label">${day.dia}</div>
                <span class="time-of-day">MA√ëANA</span>
                <span class="time-of-day">TARDE</span>
                <span class="time-of-day">NOCHE</span>
            </div>
            <div class="grid-forecast-grid">
                <div class="grid-forecast-row">
                    <div class="grid-temp-min-max">
                        <div class="max-temp"><span class="red-text">${day.max_temp}¬∞c</span></div>
                        <div class="min-temp"><span class="blue-text">${day.min_temp}¬∞c</span></div>
                    </div>
                    <div class="grid-forecast-item">
                        <div class="grid-forecast-icon">
                            <img src="images/${day.manana.tiempo.replace(/\s/g, '-').toLowerCase()}.png" alt="${day.manana.tiempo}">
                        </div>
                        <div class="grid-forecast-temp">${day.manana.temp}¬∞c</div>
                    </div>
                    <div class="grid-forecast-item">
                        <div class="grid-forecast-icon">
                            <img src="images/${day.tarde.tiempo.replace(/\s/g, '-').toLowerCase()}.png" alt="${day.tarde.tiempo}">
                        </div>
                        <div class="grid-forecast-temp">${day.tarde.temp}¬∞c</div>
                    </div>
                    <div class="grid-forecast-item">
                        <div class="grid-forecast-icon">
                            <img src="images/${day.noche.tiempo.replace(/\s/g, '-').toLowerCase()}.png" alt="${day.noche.tiempo}">
                        </div>
                        <div class="grid-forecast-temp">${day.noche.temp}¬∞c</div>
                    </div>
                </div>
                <div class="grid-forecast-row">
                    <div class="grid-forecast-label">Vientos</div>
                    <div class="grid-forecast-item">${day.manana.viento}</div>
                    <div class="grid-forecast-item">${day.tarde.viento}</div>
                    <div class="grid-forecast-item">${day.noche.viento}</div>
                </div>
                <div class="grid-forecast-row">
                    <div class="grid-forecast-label">Tiempo</div>
                    <div class="grid-forecast-item">${day.manana.tiempo}</div>
                    <div class="grid-forecast-item">${day.tarde.tiempo}</div>
                    <div class="grid-forecast-item">${day.noche.tiempo}</div>
                </div>
            </div>
        `;
        container.appendChild(daySection);
    });

    // Renderizar los d√≠as en formato de tarjeta (los d√≠as de la colecci√≥n 'semana')
    const cardContainer = document.createElement('div');
    cardContainer.className = 'card-forecast-container';
    container.appendChild(cardContainer);

    // Obtener datos de la colecci√≥n `semana`
    db.collection('ciudades').doc(targetElementId).collection('semana').get().then(snapshot => {
        snapshot.forEach(doc => {
            const card = doc.data();
            const cardElement = document.createElement('div');
            cardElement.className = 'weather-card';
            cardElement.innerHTML = `
                <div class="day-info">${card.dia}</div>
                <div class="date-info">${card.fecha}</div>
                <div class="weather-icons-temps">
                    <div class="day-weather">
                        <span style="font-size: 4em;">
                            <img src="images/${card.condicion_cielo_dia.replace(/\s/g, '-').toLowerCase()}.png" alt="${card.condicion_cielo_dia}">
                        </span>
                        <div class="temp-min-max-icon"><span class="temp-bar">üå°Ô∏è</span> <span>${card.dia_temp}¬∞c</span></div>
                    </div>
                    <div class="night-weather">
                        <span style="font-size: 4em;">
                            <img src="images/${card.condicion_cielo_noche.replace(/\s/g, '-').toLowerCase()}.png" alt="${card.condicion_cielo_noche}">
                        </span>
                        <div class="temp-min-max-icon"><span class="temp-bar">üå°Ô∏è</span> <span>${card.noche_temp}¬∞c</span></div>
                    </div>
                </div>
                <div class="sky-condition">${card.condicion_cielo}</div>
                <div class="arrow-down">‚¨áÔ∏è</div>
                <div class="wind-info">${card.viento}</div>
            `;
            cardContainer.appendChild(cardElement);
        });
    });

    const footnote = document.createElement('div');
    footnote.className = 'footnote';
    footnote.textContent = '* TEMPERATURA EN ZONA SUBURBANA';
    container.appendChild(footnote);

    dateEmission.textContent = cityData.emision.fecha;
    timeEmission.textContent = `Hora de emisi√≥n ${cityData.emision.hora}`;
}


// Funci√≥n para cargar los datos de una ciudad (se mantiene igual)
async function loadForecast(cityId) {
    try {
        const docRef = db.collection('ciudades').doc(cityId);
        const doc = await docRef.get();
        if (doc.exists) {
            currentCityData = doc.data();
            renderForecast(currentCityData, cityId);
        } else {
            console.log("No such document!");
        }
    } catch (e) {
        console.error("Error loading document:", e);
        alert('Error al cargar los datos. Intente de nuevo.');
    }
}


// L√≥gica de las pesta√±as (Ahora solo llaman a la funci√≥n unificada)
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const targetId = tab.getAttribute('data-city');
        const targetName = tab.textContent;
        activateCityTab(targetId, targetName);
    });
});


// ... (Tu l√≥gica de autenticaci√≥n y panel de admin se mantiene igual) ...
// L√≥gica de autenticaci√≥n 
auth.onAuthStateChanged(user => { 
    if (user) { 
        loginButton.style.display = 'none'; 
        logoutButton.style.display = 'block'; 
        adminPanel.style.display = 'block'; 
        generateAdminForm(); 
    } else { 
        loginButton.style.display = 'block'; 
        logoutButton.style.display = 'none'; 
        adminPanel.style.display = 'none'; 
    } 
}); 


// Funci√≥n para generar el formulario de edici√≥n 
async function generateAdminForm() { 
    const cityId = adminCitySelect.value; 
    const docRef = db.collection('ciudades').doc(cityId); 
    const doc = await docRef.get(); 
    if (!doc.exists) return; 


    const data = doc.data(); 
    const formHtml = ` 
        <h3>Datos de emisi√≥n</h3> 
        <div class="admin-form-group"> 
            <label>Fecha:</label> 
            <input type="text" id="admin-fecha" value="${data.emision.fecha}"> 
        </div> 
        <div class="admin-form-group"> 
            <label>Hora:</label> 
            <input type="text" id="admin-hora" value="${data.emision.hora}"> 
        </div> 
        
        <h3>Pron√≥stico de la Semana (D√≠as en tabla)</h3> 
        ${['hoy', 'manana'].map(dayKey => { 
            const day = data.pronostico[dayKey]; 
            return ` 
                <h4>${day.dia}</h4> 
                <div class="admin-form-group"> 
                    <label>Temperatura M√≠nima:</label> 
                    <input type="number" data-path="pronostico.${dayKey}.min_temp" value="${day.min_temp}"> 
                </div> 
                <div class="admin-form-group"> 
                    <label>Temperatura M√°xima:</label> 
                    <input type="number" data-path="pronostico.${dayKey}.max_temp" value="${day.max_temp}"> 
                </div> 
                ${['manana', 'tarde', 'noche'].map(timeKey => ` 
                    <h5>${timeKey.toUpperCase()}</h5> 
                    <div class="admin-form-group"> 
                        <label>√çcono (nombre del archivo):</label> 
                        <input type="text" data-path="pronostico.${dayKey}.${timeKey}.tiempo" value="${day[timeKey].tiempo}"> 
                    </div> 
                    <div class="admin-form-group"> 
                        <label>Temperatura:</label> 
                        <input type="number" data-path="pronostico.${dayKey}.${timeKey}.temp" value="${day[timeKey].temp}"> 
                    </div> 
                    <div class="admin-form-group"> 
                        <label>Viento:</label> 
                        <input type="text" data-path="pronostico.${dayKey}.${timeKey}.viento" value="${day[timeKey].viento}"> 
                    </div> 
                `).join('')} 
            `; 
        }).join('')} 
        
        <h3>Pron√≥stico de la Semana (D√≠as en tarjetas)</h3> 
        <p>La edici√≥n de los pron√≥sticos de tarjetas se realiza directamente en la consola de Firestore.</p> 
    `; 
    forecastForm.innerHTML = formHtml; 
} 


// L√≥gica para guardar los cambios 
saveButton.addEventListener('click', async () => { 
    const cityId = adminCitySelect.value; 
    const updates = {}; 
    const inputs = forecastForm.querySelectorAll('input[data-path]'); 
    inputs.forEach(input => { 
        const path = input.getAttribute('data-path'); 
        const value = input.type === 'number' ? parseFloat(input.value) : input.value; 
        updates[path] = value; 
    }); 
    
    updates['emision.fecha'] = document.getElementById('admin-fecha').value; 
    updates['emision.hora'] = document.getElementById('admin-hora').value; 


    try { 
        await db.collection('ciudades').doc(cityId).update(updates); 
        alert('Cambios guardados con √©xito!'); 
        // Recargar el pron√≥stico para mostrar los cambios 
        loadForecast(cityId); 
    } catch (e) { 
        console.error("Error al guardar los cambios:", e); 
        alert('Error al guardar los cambios. Intenta de nuevo.'); 
    } 
}); 


// Manejador del select de ciudades en el panel de admin 
adminCitySelect.addEventListener('change', generateAdminForm); 
    
// Manejadores de eventos del bot√≥n de login y logout 
loginButton.addEventListener('click', () => { 
    const email = prompt("Ingresa tu correo electr√≥nico:"); 
    const password = prompt("Ingresa tu contrase√±a:"); 
    if (email && password) { 
        auth.signInWithEmailAndPassword(email, password).catch(error => { 
            alert('Error al iniciar sesi√≥n: ' + error.message); 
        }); 
    } 
}); 


logoutButton.addEventListener('click', () => { 
    auth.signOut(); 
}); 


// Llama a la funci√≥n de inicializaci√≥n de Leaflet y carga el pron√≥stico inicial.
document.addEventListener('DOMContentLoaded', () => { 
    initLeafletMap();
    // Usamos el id 'la-plata' y su nombre de ciudad para la carga inicial
    activateCityTab('la-plata', 'LA PLATA'); 
});
